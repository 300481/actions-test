name: update chart versions

on: 
  repository_dispatch:
    types: [artifacthub]

jobs:
  update_chart_versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: setup git config
        run: |
          git config user.name "GitHub Actions"
          git config user.email "<>"
      - name: show version
        run: |
          echo "${{ github.event.client_payload.data.package.repository.name }}/${{ github.event.client_payload.data.package.name }}:${{ github.event.client_payload.data.package.version }}"
      - name: yq - update package version
        uses: mikefarah/yq@v4.9.2
        with:
          cmd: yq eval '.${{ github.event.client_payload.data.package.repository.name }}.${{ github.event.client_payload.data.package.name }}.version = "${{ github.event.client_payload.data.package.version }}"' -i current-chart-versions.yaml
      - name: show content
        run: cat current-chart-versions.yaml
      - name: commit and push
        run: |
          # Stage the file, commit and push
          git add current-chart-versions.yaml
          git commit -m "update version of ${{ github.event.client_payload.data.package.repository.name }}/${{ github.event.client_payload.data.package.name }} to ${{ github.event.client_payload.data.package.version }}"
          git push origin main
